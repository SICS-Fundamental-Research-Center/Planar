#include "data_structures/graph/immutable_csr_graph.h"

#include <gtest/gtest.h>

#include "common/multithreading/thread_pool.h"
#include "common/types.h"
#include "data_structures/graph/immutable_csr_graph_config.h"
#include "data_structures/graph/serialized_immutable_csr_graph.h"

using ImmutableCSRGraph =
    sics::graph::core::data_structures::graph::ImmutableCSRGraph;
using SerializedImmutableCSRGraph =
    sics::graph::core::data_structures::graph::SerializedImmutableCSRGraph;
using Serialized = sics::graph::core::data_structures::Serialized;
using BasicReader = sics::graph::core::io::BasicReader;
using BasicWriter = sics::graph::core::io::BasicWriter;
using VertexID = sics::graph::core::common::VertexID;
using ImmutableCSRGraphConfig =
    sics::graph::core::data_structures::graph::ImmutableCSRGraphConfig;
using ThreadPool = sics::graph::core::common::ThreadPool;

namespace sics::graph::core::test {
template <typename Derived, typename Base>
std::unique_ptr<Derived> dynamic_ptr_cast(
    std::unique_ptr<Base>&& base) noexcept {
  if (auto derived = dynamic_cast<Derived*>(base.get())) {
    base.release();
    return std::unique_ptr<Derived>(derived);
  }

  return nullptr;
}

class SerializableImmutableCSRTest : public ::testing::Test {
 protected:
  SerializableImmutableCSRTest() {
    // Initialize Serialized objects.
    serialized_immutable_csr_0_ = std::make_unique<SerializedImmutableCSRGraph>();
    serialized_immutable_csr_1_ = std::make_unique<SerializedImmutableCSRGraph>();

    // Initialize test configs.
    config_0_ = {
        28,  // num_vertex
        27,  // max_vertex
        61,  // sum_in_degree
        68,  // sum_out_degree
    };
    config_1_ = {
        28,  // num_vertex
        55,  // max_vertex
        39,  // sum_in_degree
        32,  // sum_out_degree
    };
  }

  ~SerializableImmutableCSRTest() override = default;

  size_t compute_total_size(ImmutableCSRGraphConfig config) {
    VertexID aligned_max_vertex = (config.max_vertex + 63) / 64 * 64;
    size_t size_localid = sizeof(VertexID) * config.num_vertex;
    size_t size_globalid = sizeof(VertexID) * config.num_vertex;
    size_t size_indegree = sizeof(size_t) * config.num_vertex;
    size_t size_outdegree = sizeof(size_t) * config.num_vertex;
    size_t size_in_offset = sizeof(size_t) * config.num_vertex;
    size_t size_out_offset = sizeof(size_t) * config.num_vertex;
    size_t size_in_edges = sizeof(VertexID) * config.sum_in_edges;
    size_t size_out_edges = sizeof(VertexID) * config.sum_out_edges;
    size_t size_localid_by_globalid = sizeof(VertexID) * aligned_max_vertex;

    size_t expected_size = size_localid + size_globalid + size_indegree +
                           size_outdegree + size_in_offset + size_out_offset +
                           size_in_edges + size_out_edges +
                           size_localid_by_globalid;

    return expected_size;
  }

  // SerializedImmutableCSR* serialized_immutable_csr_0_;
  // SerializedImmutableCSR* serialized_immutable_csr_1_;
  std::unique_ptr<SerializedImmutableCSRGraph> serialized_immutable_csr_0_;
  std::unique_ptr<SerializedImmutableCSRGraph> serialized_immutable_csr_1_;
  ImmutableCSRGraphConfig config_0_, config_1_;
  std::string data_dir = TEST_DATA_DIR;
  std::string subgraph_0_path = data_dir + "/input/small_graph_part/0";
  std::string subgraph_1_path = data_dir + "/input/small_graph_part/1";
  std::string write_0_path = data_dir + "/output/writer_test/0";
  std::string write_1_path = data_dir + "/output/writer_test/1";
};

TEST_F(SerializableImmutableCSRTest, TestDeserialize4Subgraph_0) {
  // Initialize reader.
  BasicReader reader;

  // Initialize immutable csr.
  ImmutableCSRGraph serializable_immutable_csr(0, std::move(config_0_));

  // Read a subgraph
  reader.ReadSubgraph(subgraph_0_path, serialized_immutable_csr_0_.get());

  /* Test: whether loaded */
  size_t loaded_size =
      serialized_immutable_csr_0_->GetCSRBuffer().front().front().GetSize();
  size_t expected_size = compute_total_size(config_0_);
  EXPECT_EQ(expected_size, loaded_size);

  // Deserialize
  ThreadPool thread_pool(1);
  serializable_immutable_csr.Deserialize(
      thread_pool, std::move(serialized_immutable_csr_0_));

  /* Test: check global id value */
  VertexID* globalid_ptr =
      (VertexID*)(serializable_immutable_csr.GetGlobalIDByIndex());
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(globalid_ptr[i], i);
  }

  /* Test: check local id value */
  VertexID* localid_ptr =
      (VertexID*)(serializable_immutable_csr.GetLocalIDByGlobalID());
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(localid_ptr[globalid_ptr[i]], i);
  }

  /* Test: check in degree */
  size_t* indegree_ptr = (size_t*)(serializable_immutable_csr.GetInDegree());
  size_t expect_indegree[28] = {3, 3, 1, 2, 4, 4, 1, 2, 1, 1, 1, 2, 4, 4,
                                3, 1, 1, 2, 2, 2, 2, 3, 3, 2, 1, 1, 1, 4};
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(indegree_ptr[i], expect_indegree[i]);
  }

  /* Test: check out degree */
  size_t* outdegree_ptr = (size_t*)(serializable_immutable_csr.GetOutDegree());
  size_t expect_outdegree[28] = {3, 3, 3, 0, 4, 4, 4, 3, 0, 3, 0, 4, 4, 4,
                                 3, 4, 0, 3, 3, 2, 2, 3, 3, 2, 0, 0, 0, 4};
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(outdegree_ptr[i], expect_outdegree[i]);
  }

  /* Test: check in edges of vertex 0 (local id) */
  size_t* in_offset_ptr_0 = (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_0 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_0[3] = {1, 2, 19};
  for (int i = 0; i < 3; ++i) {
    EXPECT_EQ(in_edge_ptr_0[in_offset_ptr_0[0] + i], expect_in_edges_0[i]);
  }

  /* Test: check out edges of vertex 0 (local id) */
  size_t* out_offset_ptr_0 =
      (size_t*)(serializable_immutable_csr.GetOutOffset());
  VertexID* out_edge_ptr_0 =
      (VertexID*)(serializable_immutable_csr.GetOutEdges());
  size_t expect_out_edges_0[3] = {1, 2, 19};
  for (int i = 0; i < 3; ++i) {
    EXPECT_EQ(out_edge_ptr_0[out_offset_ptr_0[0] + i], expect_out_edges_0[i]);
  }

  /* Test: check in edges of vertex 15 (local id) */
  size_t* in_offset_ptr_15 =
      (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_15 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_15[1] = {13};
  for (int i = 0; i < 1; ++i) {
    EXPECT_EQ(in_edge_ptr_15[in_offset_ptr_15[15] + i], expect_in_edges_15[i]);
  }

  /* Test: check out edges of vertex 15 (local id) */
  size_t* out_offset_ptr_15 =
      (size_t*)(serializable_immutable_csr.GetOutOffset());
  VertexID* out_edge_ptr_15 =
      (VertexID*)(serializable_immutable_csr.GetOutEdges());
  size_t expect_out_edges_15[4] = {13, 16, 28, 35};
  for (int i = 0; i < 4; ++i) {
    EXPECT_EQ(out_edge_ptr_15[out_offset_ptr_15[15] + i],
              expect_out_edges_15[i]);
  }

  /* Test: check in edges of vertex 27 (local id) */
  size_t* in_offset_ptr_27 =
      (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_27 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_27[4] = {13, 17, 41, 44};
  for (int i = 0; i < 4; ++i) {
    EXPECT_EQ(in_edge_ptr_27[in_offset_ptr_27[27] + i], expect_in_edges_27[i]);
  }

  /* Test: check out edges of vertex 15 (local id) */
  size_t* out_offset_ptr_27 =
      (size_t*)(serializable_immutable_csr.GetOutOffset());
  VertexID* out_edge_ptr_27 =
      (VertexID*)(serializable_immutable_csr.GetOutEdges());
  size_t expect_out_edges_27[4] = {13, 17, 41, 44};
  for (int i = 0; i < 4; ++i) {
    EXPECT_EQ(out_edge_ptr_27[out_offset_ptr_27[27] + i],
              expect_out_edges_27[i]);
  }
}

TEST_F(SerializableImmutableCSRTest, TestDeserialize4Subgraph_1) {
  // Initialize reader.
  BasicReader reader;

  // Initialize immutable csr.
  ImmutableCSRGraph serializable_immutable_csr(1, std::move(config_1_));

  // Read a subgraph
  reader.ReadSubgraph(subgraph_1_path, serialized_immutable_csr_1_.get());

  /* Test: whether loaded */
  size_t loaded_size =
      serialized_immutable_csr_1_->GetCSRBuffer().front().front().GetSize();
  size_t expected_size = compute_total_size(config_1_);
  EXPECT_EQ(expected_size, loaded_size);

  // Deserialize
  ThreadPool thread_pool(1);
  serializable_immutable_csr.Deserialize(
      thread_pool, std::move(serialized_immutable_csr_1_));

  /* Test: check global id value */
  VertexID* globalid_ptr =
      (VertexID*)(serializable_immutable_csr.GetGlobalIDByIndex());
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(globalid_ptr[i], i + 28);
  }

  /* Test: check local id value */
  VertexID* localid_ptr =
      (VertexID*)(serializable_immutable_csr.GetLocalIDByGlobalID());
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(localid_ptr[globalid_ptr[i]], i);
  }

  /* Test: check in degree */
  size_t* indegree_ptr = (size_t*)(serializable_immutable_csr.GetInDegree());
  size_t expect_indegree[28] = {1, 1, 1, 2, 3, 2, 1, 1, 2, 1, 2, 1, 1, 2,
                                1, 1, 4, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1};
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(indegree_ptr[i], expect_indegree[i]);
  }

  /* Test: check out degree */
  size_t* outdegree_ptr = (size_t*)(serializable_immutable_csr.GetOutDegree());
  size_t expect_outdegree[28] = {0, 0, 0, 3, 3, 4, 0, 0, 2, 0, 4, 3, 0, 3,
                                 3, 1, 4, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0};
  for (int i = 0; i < 28; ++i) {
    EXPECT_EQ(outdegree_ptr[i], expect_outdegree[i]);
  }

  /* Test: check in edges of vertex 0 (local id) */
  size_t* in_offset_ptr_0 = (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_0 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_0[1] = {15};
  for (int i = 0; i < 1; ++i) {
    EXPECT_EQ(in_edge_ptr_0[in_offset_ptr_0[0] + i], expect_in_edges_0[i]);
  }

  /* Test: check in edges of vertex 15 (local id) */
  size_t* in_offset_ptr_15 =
      (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_15 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_15[1] = {44};
  for (int i = 0; i < 1; ++i) {
    EXPECT_EQ(in_edge_ptr_15[in_offset_ptr_15[15] + i], expect_in_edges_15[i]);
  }

  /* Test: check out edges of vertex 15 (local id) */
  size_t* out_offset_ptr_15 =
      (size_t*)(serializable_immutable_csr.GetOutOffset());
  VertexID* out_edge_ptr_15 =
      (VertexID*)(serializable_immutable_csr.GetOutEdges());
  size_t expect_out_edges_15[1] = {44};
  for (int i = 0; i < 1; ++i) {
    EXPECT_EQ(out_edge_ptr_15[out_offset_ptr_15[15] + i],
              expect_out_edges_15[i]);
  }

  /* Test: check in edges of vertex 27 (local id) */
  size_t* in_offset_ptr_27 =
      (size_t*)(serializable_immutable_csr.GetInOffset());
  VertexID* in_edge_ptr_27 =
      (VertexID*)(serializable_immutable_csr.GetInEdges());
  size_t expect_in_edges_27[1] = {38};
  for (int i = 0; i < 1; ++i) {
    EXPECT_EQ(in_edge_ptr_27[in_offset_ptr_27[27] + i], expect_in_edges_27[i]);
  }
}

TEST_F(SerializableImmutableCSRTest, TestSerialize4Subgraph0) {
  // Initialize reader & writer.
  BasicReader reader;
  BasicWriter writer;

  // Initialize immutable csr.
  ImmutableCSRGraph serializable_immutable_csr(0, std::move(config_0_));

  // Read a subgraph
  reader.ReadSubgraph(subgraph_0_path, serialized_immutable_csr_0_.get());

  // Deserialize
  ThreadPool thread_pool(1);
  serializable_immutable_csr.Deserialize(
      thread_pool, std::move(serialized_immutable_csr_0_));

  // Modify the immutable csr.
  // Modify in degree
  size_t* indegree_ptr = (size_t*)(serializable_immutable_csr.GetInDegree());
  indegree_ptr[0] = 100;
  indegree_ptr[1] = 200;

  // Serialize
  auto serialized_immutable_csr_r = serializable_immutable_csr.Serialize(thread_pool);

  // Write the subgraph
  writer.WriteSubgraph(write_0_path, serialized_immutable_csr_r.get());

  // re-Read the subgraph
  ImmutableCSRGraph serializable_immutable_csr_r(0, std::move(config_0_));
  reader.ReadSubgraph(write_0_path, serialized_immutable_csr_1_.get());
  serializable_immutable_csr_r.Deserialize(
      thread_pool, std::move(serialized_immutable_csr_1_));
  
  // Check the in degree
  size_t* indegree_ptr_r = (size_t*)(serializable_immutable_csr_r.GetInDegree());
  size_t expect_indegree[28] = {100, 200, 1, 2, 4, 4, 1, 2, 1, 1, 1, 2, 4, 4,
                                3,   1,   1, 2, 2, 2, 2, 3, 3, 2, 1, 1, 1, 4};
  for (int i = 0; i <3; ++i) {
    EXPECT_EQ(indegree_ptr_r[i], expect_indegree[i]);
  }
}

}  // namespace sics::graph::core::test
